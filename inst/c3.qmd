---
title: "Developing the mizerReef package - a collection of vignettes"
#bibliography: "references.bib"
#csl: "ecology.csl"
execute: 
  echo: false
format:
  html:
    toc: false
    toc-depth: 4
    code-fold: true
    code-link: true
  pdf:
    toc: false
    toc-depth: 4
    number-sections: true
    number-depth: 3
editor: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
library(ggplot2)
library(dplyr)
library(knitr)
library(knitcitations)
library(mizer)
# remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
# remotes::install_github("cmbeese/mizerReef")
library(mizerReef)
params <- rogers_params
```

# Introduction

While only a small proportion of coral reef fish species associate closely
with live coral, habitat structure strongly influences biodiversity, 
community structure, and ecosystem service provision [@Graham_2013]. The 
primary mechanism by which coral reef structures mediate system dynamics 
is through the provision of predation refuge [@Beukers1998, @Almany_2004]. 
On coral reefs, refuge use is primarily governed by body size, as the most 
effective refuges fit prey while excluding predators [@Hixon_1993]. This is
reflected in the size-structure of coral reef fish assemblages, which tend
to follow the size-structure of refuge holes on a given reef [@Nash_2014]. 
Size spectrum models capture the ways that communities of individuals grow 
and change trophic level through ontogeny [@Scott_2014]. Since the protection
offered by refuges is size-dependent, size-spectrum models can provide unique
insights into how the scale and arrangement of benthic structures can impact
community dynamics.

The size-spectrum ecosystem model presented in Chapter 2 serves as a valuable 
predictive tool for understanding high-level outcomes within coral reef 
ecosystems, but it is limited in its resolution and fails to capture key 
dynamics such as reproduction. 

\hl{ADD:
\begin{itemize}
    \item Importance of recruitment, density dependence of reproduction,
    especially in context of supporting ecosystem services
    \item Importance of fisher behavior - different gear types, size and
    species restrictions, area closures
    \item quick review of the other tools we currently have to look at
    productivity - Morais method - lack of predictive power
    \item quick mention of importance of habitat complexity in context of 
    supporting ecosystem services
\end{itemize}
}
    

The R package Mizer sets up dynamic, multi-species size-spectrum models of fish communities [@mizer]. Dynamics are governed by the same McKendrick von-Foerster
system of equations that formed the basis for the model described in Chapter 2, 
with components added to account for density-dependent recruitment, 
consumer satiation, and ecosystem carrying capacities. However, Mizer was 
designed to assess the impacts of fishing on pelagic systems and does not 
capture key drivers of dynamics in coastal regions such as benthic resources 
and habitat complexity. To provide more accessible predictive tools for
ecosystem managers, I have developed an R extension package that modifies
mizer to better reflect tropical reef ecology.

This chapter introduces mizerReef, a R extension package for Mizer that makes
it easy to set up a size spectrum model for a tropical coral reef ecosystem. 
The source code for mizerReef is hosted at https://github.com/cmbeese/mizerReef. 
The package can be used to simulate the size spectrum dynamics in a tropical 
coral reef community. It is not a ‘community assessment’ tool (i.e. it does 
not ‘fit’ the model to assess the current state of the community) but 
simulates the potential consequences of various benthic states and 
fishing patterns, conditional on the model assumptions and parameter values.

# Methods

## Functional Groups {#sec:groups}

This document details the structure of a typical mizerReef model and includes
parameters for an example tropical coral reef ecosystem model set up with 
mizerReef. The model consists of a collection of fish and invertebrate 
[functional groups](#groups) supported by a collection of 
[resources](#resources). All predator-prey interactions are mediated by 
habitat structure, which determines the availability of [refuge](#refuge). 

Example parameters were chosen to describe a Caribbean coral reef ecosystem.
Numerical values for the parameters associated with each section are provided 
under the "Parameter values" subsections. Many of the parameters were taken 
from @Rogers_2014 and @Beese_2023 to allow for comparison of results. 

::: {.content-visible when-format="html"}
These parameter value sections start with a "Skip" link that allows you
to jump over them to the next section of model description.
:::

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Size-spectrum dynamics]
:::

The model includes `r nrow(params@species_params)-1` functional groups
of fish as well as a general group of benthic invertebrates. Estimates
of observed abundances for each group  were to used select reproduction 
parameters (discussed later) so that the steady state abundances in the 
model agree with these observations.

Biomass estimates for were based on data collected from relatively 
un-fished reefs within a marine reserve in Bonaire [@Rogers_2014]. Fish
less than 10 cm in length were excluded from analysis as their
abundance is not well captured by visual methods [@Ackerman_2000]. The
cutoff weight for observed biomass estimates was calculated using 
published length-weight relationships.The cutoff size is given in 
@tbl-biomass along with the observed biomass per square meter in grams.

```{r}
#| label: tbl-biomass
#| tbl-cap: Observed biomasses
params@species_params %>%
    filter(!is.na(biomass_observed)) %>%
    select(biomass_observed, biomass_cutoff) %>%
    kable(col.names = c("Biomass [g/m^2]", "Cutoff Size [g]"))
```

## Size-spectrum dynamics

The model assumes that, to a first approximation, an individual can be
characterized by its weight $w$ and its functional group number $i$
only. The aim of the model is to calculate the size spectrum $N_i(w)$,
which is the *density* of individuals of functional group $i$ and size
$w$. The number of individuals in a size range is obtained from the
density by integrating over the size range, such that
$\int_w^{w+dw}N_i(w)dw$ is the number of individuals of group $i$ in the
size interval $[w,w+dw]$. In other words: the number of individuals in a
size range is the area under the number density $N_i(w)$.

The time evolution of the number density $N_i(w)$ is described by the
McKendrick-von Foerster equation, which is a transport equation
describing the transport of biomass from small to large individuals,
with an additional loss term due to fish mortality:

$$
  \frac{\partial N_i(w)}{\partial t} + \frac{\partial g_i(w) N_i(w)}{\partial w} 
  = -\mu_i(w) N_i(w).
$$ {#eq-MvF}

The individual growth rate $g_i(w)$ is described below in the
[Growth](#growth) section and the mortality rate $\mu_i(w)$ is described
in the [Mortality](#mortality) section. These rates depend on the
structural complexity of the reef and the density of other fish of other
sizes, as well as biomass of plankton, algae and detritus resources,
making the size-spectrum dynamics non-linear and non-local in very
interesting ways. The resulting effects are too complicated to
disentangle by pure thought. This is where simulations with the mizer
package come in.

There is no need to understand the mathematical notation used in the
McKendrick-von Foerster equation to understand its origin: it just says
that the rate at which the number of fish in a size bracket increases is
the rate at which fish grow into the size bracket from a smaller size
minus the rate at which fish grow out of it to a larger size minus the
rate at which the fish in the size bracket die.

For the smallest size class, instead of a rate of growth into the size
class there is a rate of reproduction of new individuals into that size
class. This reproduction will be described below in the
[Reproduction](#reproduction) section.

### Growth {#growth}

Consumers can only grow by consuming food (i.e. plankton, algae,
detritus, or other fish), discounting the losses due to metabolic
processes. Predation includes a model for the [predator-prey encounter
rate](#sec:pref) and a model for the rate of [consumption](#consumption). 
The rate at which predators encounter prey is modified by habitat 
complexity, which provides predation refuge that prevents certain prey 
from being encountered. Taking into account the rate of 
[metabolic losses], the resulting energy intake can be partitioned 
in the model as energy allocated to [reproduction](#sec:repro) and 
energy allocated to [somatic growth](#somatic-growth).

#### Predator-prey encounter rate {#sec:pref}

The rate $E_{i}(w)$ at which a predator of group $i$ and weight $w$
encounters food (mass per time) is obtained by summing over all prey
group and integrating over all prey sizes $w_p$, weighted by the
selectivity factors described below and (where relevant) adding the
encounter rates $E_{A.i}$ of algae and $E_{D.i}$ of detritus:

$$
  E_{i}(w) = \gamma_i(w) \int \sum_{j} \theta_{ij} V_{ij}(w_p) N_j(w_p)
  \phi_i(w,w_p) w_p \, dw_p + E_{A.i}(w) + E_{D.i}(w).
$$ {#eq-encounter}

The encounter rates for [algae](#algae-consumption) and
[detritus](#detritus-consumption) are described in later sections.

The overall prefactor $\gamma_i(w)$ sets the predation power of the
predator. It could be interpreted as a search volume or as an attack
rate. By default it is assumed to scale allometrically as
$\gamma_i(w) = \gamma_i\, w^{3/4}.$ In order for $E_i(w)$ to have units
of grams per year, the prefactor $\gamma_i$ has to have a unit of
$\text{grams}^{-3/4}$ per year.

The $\theta_{ij}$ matrix sets the interaction strength between predator
group $i$ prey group $j$.

$V_{ij}(w_p)$ sets the vulnerability of prey species $j$ and weight
$w_p$ to predation by predator species $i$. Vulnerability is determined
by the presence of [predation refuge](#refuge).

The size selectivity is encoded in the predation kernel $\phi_i(w,w_p)$.
For most groups we use the lognormal predation kernel given as

$$
\phi_i(w, w_p) = 
\exp \left[ \frac{-(\ln(w / w_p / \beta_i))^2}{2\sigma_i^2} \right]
$$ {#eq-phi_normal} if $w/w_p$ is larger than 1 and zero otherwise. Here
$\beta_i$ is the preferred predator-prey mass ratio and $\sigma_i$
determines the width of the kernel.

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Predation Refuge](#refuge)
:::

The predator/prey interaction matrix has entries equal to either 0 (if
the groups can not interact) or 1, see @fig-interaction.

```{r}
#| label: fig-interaction
#| fig-cap: "group interaction matrix"
ggplot(melt(params@interaction),
       aes(x = prey, y = reorder(predator, desc(predator)), fill = value)) + 
    geom_tile(colour = "black", linewidth = 0.25) +
    scale_fill_gradient(low = "white", high = "blue", limit = c(0, 1),
                        guide = "legend") +
    ylab("predator") +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

The parameters for the predation kernels were chosen to reflect relative 
differences in foraging prefereces between predator functional groups. 
Initial estimates were based on published PPMR data for several species
within eahc group [@REFERENCES FOR PPMR]. These were then adjusted based on functional group characteristics such as preferred prey, predatory mode, 
and gape size. The parameters are given in @tbl-lognormal.

```{r results='asis'}
#| label: tbl-lognormal
#| tbl-cap: Parameters for the lognormal predation kernels
params@species_params %>%
    filter(pred_kernel_type == "lognormal") %>%
    select(beta, sigma, gamma) %>%
    kable()
```

#### Predation Refuge {#refuge}

Complex biogenic structures mediate the process of predation on reef
habitats. To account for this, we reduce the rate at which a predator
encounters prey at a level proportional to the availability of
appropriately sized **predation refuges**, which prevent prey fish from
being encountered. The refuge function, $R_j(w_p)$, describes the
proportion of fish of size $w_p$ in prey group $j$ that are hidden from
predators. We refer to the set of proportions that describe refuge
availability across the entire size range of model fish as a 
**refuge profile**. $1 - R_j(w_p)$ is then the proportion of fish
of weight $w_p$ and prey group $j$ that are vulnerable to consumption 
by predators.

Individuals smaller than $w_{settle}$ represent pelagic larval fish that 
have not yet settled to the reef substrate and are too small to utilize 
refuge to avoid predation. The default value for this minimum weight is 
0.1 grams. All individuals below this size are assumed to be vulnerable to predators. To ensure some food is always available, the maximum value of 
$R_j(w_p)$ is set to $R_{max}$, which defaults to 98\%.

Refuge can be suppressed for functional groups which are not expected to 
utilize biogenic structures for protection (e.g. schooling species) with 
the [refuge\_user] parameter in the species parameters data frame.

The mizerReef package provides three methods to define the overall
refuge profile of a reef depending on the availability of habitat
complexity data for the modelled area.

##### Sigmoidal

This method is best suited to data-poor reefs or reefs where the refuge
distribution is unknown. It is akin to the way refuge was defined in 
@Rogers_2014 The proportion of prey of weight $w_p$ and functional 
group $j$ with access to refuge $R_j(w_p)$ is given by the sigmoid function:

$$
R_j(w_p) = \frac{r}{1 + e^{\left(\alpha (w - W_{refuge})\right)}}
$$ {#eq-refuge_simple}

Here $W_{refuge}$ defines the weight at which refuges transition from being 
widely available to becoming unavailable. 

$r$ defines the maximum proportion of fish with access to predation 
refuge and is always less than or equal to $R_{max}$.

$\alpha$ controls the rate at which the availability of 
refuge decreases with increasing body size. A smaller $\alpha$ results in 
a more gradual decrease in refuge availability, while the default value 
of 100 results in a steeper decline. 

This sigmoid takes on values between $0$ and $R_{max}$. The body weight at 
which refuge becomes scarcer for prey is marked by $W_{refuge}$. 

##### Binned

This method is appropriate for theoretical applications and does not
rely on complexity data. It is analagous to the way refuge was defined in
@Beese_2023. It sets the availability of refuge to a constant proportion 
of fish within a given size range. The proportion of fish in functional 
group $j$ and weight $w_p$ with access to refuge $R_j(w_p)$ is given by:

$$
R_j(w_p) = r_k ~~~~~~~ w_p \in (~w_{k-1}, w_k~]
$$ {#eq-refuge_binned}

where $w_p$ is the weight of the prey and $r_k$ is the proportion of
fish with access to refuge in size class $k$.

##### Competitive

This method is appropriate when **refuge density** data is available for
the modeled reef and mirrors the way refuge was defined in @Rogers_2017 
and @Rogers_2018. The **refuge density** describes the distribution of refuges 
across defined fish body size categories. The proportion of prey of weight 
$w_p$ and functional group $j$ with access to refuge $R_j(w_p)$ is given by

$$
R_j(w_p) = min\left \{R_{max} \, , \frac{\tau\cdot\eta_k}{\sum_{i}\int_{w_{k-1}}^{w_k} N_i(w)~dw}
            ~~~~~~~ w_p \in (~w_{k-1}, w_k~] \right \}
$$ {#eq-refuge_data}

The parameter $\tau$ is the proportion of fish with access to refuge that are
expected to utilize it, $\eta_k$ is the density $no./m^{2}$ of refuges in 
size range $(w_{k-1}, w_k]$ and $\sum_{i} \int_{w_{k-1}}^{w_k} N_i(w)~dw$ 
gives the density $g/m^{2}$ of fish from any group in size range 
$(w_{k-1}, w_k]$. This represents the density of competitors for 
refuges in size class $k$.

##### Vulnerability

The vulnerability of prey of weight $w_p$ in group $j$ to predation by a
predator in functional group $i$ is then given by:

$$
V_{ij}(w_p) =  1 - \nu_i\cdot R_j(w_p)
$$ {#eq-vulnerability}

where $\nu_i$ represents whether predators in functional group $i$ are
able to access prey within refuge. For functional groups where $\nu_i$
is false, some aspect of their morphology or foraging strategy allows
them to access prey hidden in refuge; for example large eels that can
fit into crevices much smaller than their body size. For these
predators, vulnerability for all prey is set to 1.

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Consumption](#consumption)
:::

The refuge profile gives the proportion of fish at each size that are
protected from being encountered by predators, see @fig-refuge.

```{r}
#| label: fig-refuge
#| fig-cap: "Example refuge profile"
plotRefuge(params)
```

@tbl-refuge indicates which prey functional groups use refuge to escape
from predators and which predator groups are able to access prey within
refuge.

```{r}
#| label: tbl-refuge
#| tbl-cap: "refuge behaviour"
params@species_params %>%
    select(refuge_user, bad_pred) %>%
    mutate(refuge_user  = case_when(refuge_user == TRUE ~ 'Yes',
                                    refuge_user == FALSE ~ 'No')) %>%
    mutate(bad_pred = case_when(bad_pred == TRUE ~ 'No',
                                bad_pred == FALSE ~ 'Yes')) %>%
    kable(col.names = c("Uses refuge?", "Accesses prey in refuge?"))
```

#### Consumption {#consumption}

For all non-piscivorous functional groups, encountered food is consumed
subject to a standard Holling functional response type II to represent
satiation. This determines the *feeding level* $f_i(w)$, which is a
dimensionless number between 0 (no food) and 1 (fully satiated) so that
$1-f_i(w)$ is the proportion of the encountered food that is consumed.

In mizerReef models, feeding level only applies to herbivorous and
detritivorous functional groups. Predation is regulated by refuge,
and no maximum intake rate is imposed for piscivores.

The feeding level is given by

$$
  f_i(w) = \frac{E_i(w)}{E_i(w) + h_i(w)},
$$ {#eq-fl} where $h_i(w)$ is the maximum consumption rate of a consumer
of group $i$ and weight $w$. By default we assume an allometric form
$h_i(w) = h_i\, w^n$ with $n=0.7$. The unit of the coefficients $h_i$
are $\text{grams}^{1-n}$ per year.

The rate at which food is consumed by an individual of group $i$ and
weight $w$ is then $$
(1-f_i(w))E_{i}(w)=f_i(w)\, h_i(w).
$$ {#eq-consumption} Only a proportion $\alpha_i$ of this consumed
biomass is retained, while a proportion $1-\alpha_i$ is expelled in the
form of feces, which contribute to detritus.

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Metabolic losses]
:::

No maximum consumption rates were imposed in this example.

```{r}
#| label: tbl-h
#| tbl-cap: Consumption parameters
params@species_params %>%
    filter(pisc == FALSE) %>%
    select(h, alpha, n) %>%
    kable()
```

```{r}
# plotFeedingLevel(params)
```

#### Metabolic losses

Some of the food consumed is used to fuel the needs for metabolism,
activity and movement, at a rate $\mathtt{metab}_i(w)$. By default this
is made up out of standard metabolism, scaling with exponent $p$, and
loss due to activity and movement, scaling with exponent $1$: 
$$
\mathtt{metab}_i(w) = k_{s.i}\,w^p + k_i\,w.
$$ {#eq-metab} The units of the coefficients $k_{s.i}$ are
$\text{grams}^{1-p}$ per year and the units of the $k_i$ is grams per
year.

The remaining energy, if any, is then available for growth and
reproduction, at the rate 
$$
  E_{r.i}(w) = \max(0, \alpha_i f_i(w)\, h_i(w) - \mathtt{metab}_i(w))
$$ {#eq-Er}

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Investment into reproduction](#sec:repro)
:::

```{r}
#| label: tbl-metab
#| tbl-cap: Metabolism parameters
params@species_params %>%
    select(ks, p, k) %>%
    kable()
```

#### Investment into reproduction {#sec:repro}

A proportion $\psi_i(w)$ of the energy available for growth and
reproduction is used for reproduction. This proportion changes from zero
below the weight $w_{mat.i}$ of maturation to one at the maximum weight
$w_{max.i}$, where all available energy is used for reproduction. The
expression is $$ 
\psi_i(w) = \begin{cases}
\left[1+\left(\frac{w}{w_{mat}}\right)^{-U}\right]^{-1}
\left(\frac{w}{w_{max}}\right)^{m-n}&w<w_{max}\\
1&w\geq w_{max}\end{cases}
$$ {#eq-psi} with $m-n = 0.3$ and $U=10$ (which sets the steepness of
the sigmoidal switch-on of reproduction at around the maturity weight
$w_{mat}$).

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Somatic growth](#somatic-growth)
:::

```{r}
#| label: tbl-repro
#| tbl-cap: Parameters determining the investment into reproduction.
params@species_params %>%
    select(w_mat, w_max) %>%
    kable()
```

#### Somatic growth {#somatic-growth}

What is left over after metabolism and reproduction is taken into
account is invested in somatic growth. Thus the growth rate of an
individual of functional group $i$ and weight $w$ is $$
  g_i(w) = E_{r.i}(w)\left(1-\psi_i(w)\right).
$$ {#eq-growth} When food supply does not cover the requirements of
metabolism and activity, growth and reproduction stops, i.e. there is no
negative growth.

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Mortality](#mortality)
:::

The values for the model parameters were chosen so that the resulting
growth curves would be close to von Bertalanffy growth curves. The
parameters in @tbl-kvb were taken from the literature.

```{r}
#| label: tbl-kvb
#| tbl-cap: Parameters for observed vonBertalanffy growth curves and length-weight relationships
params@species_params %>%
    select(a, b) %>%
    kable()
```

Here the parameters $a$ and $b$ are parameters for the allometric
weight-length relationship $w = a l^b$ where $w$ is measured in grams
and $l$ is measured in centimetres.

```{r, out.width="100%"}
#| label: fig-growth
#| fig-cap: Comparison of model growth curves with von Bertalanffy growth curves.
# plotGrowthCurves(params, species_panel = TRUE)
```

### Mortality {#mortality}

The mortality rate $\mu_i(w)$ of an individual of group $i$ and weight
$w$ has three sources: predation mortality $\mu_{p.i}(w)$, external
mortality $\mu_{ext.i}(w)$, fishing mortality $\mu_{f.i}(w)$. External
mortality is composed of residual natural mortality $\mu_{nat.i}(w)$, and senescence $\mu_{sen.i}(w)$. The mortality rate for group $i$ is then given by: 
$$
\mu_i(w)=\mu_{p.i}(w)+\mu_{ext.i}(w)+\mu_{f.i}(w)
$$ {#eq-mort} We will now explain each of the terms.

#### Predation mortality

All consumption by fish translates into corresponding predation
mortalities on the ingested prey individuals. the rate at which all predators
from $j$ consume prey of size $w_p$ is 
$$
  \mathtt{pred\_rate}_j(w_p) = \int 
  \phi_j(w,w_p) (1-f_j(w)) \gamma_j(w) N_j(w) \, dw.
$$ {#eq-pred_rate}

The mortality rate due to predation is then obtained as 

$$
  \mu_{p.i}(w_p) = \sum_j \mathtt{pred\_rate}_j(w_p)\, V_{ji}(w_p)\, \theta_{ji}.
$$ {#eq-mup}

#### Residual natural mortality {#extmort}

Mortality caused by illness, fishing, or predators not explicitly included 
in the model is captured by $\mu_{nat.i}(w)$, which is independent of the
functional groups and group abundances. It is assumed to decrease 
allometrically with body size:

$$
\mu_{nat.i}(w) = \mu_{nat} w^{1 - n}
$$ {#eq-z0} where $\mu_{nat}$ is the residual natural mortality rate 
and $n$ is the allometric scaling exponent. 

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Senescence mortality]
:::

```{r}
ext_mort <- params@other_params[['ext_mort_params']]
```

We use a residual mortality rate of $\mu_{nat} =$ `r ext_mort$nat_mort`

#### Senescence mortality {#senmort}

Senescence mortality $\mu_{sen.i}(w)$ is intended to capture mortality due 
to illness or old age. It is independent of group abundances. Senescence 
mortality is assumed to increase allometrically with body size. The rate 
of senescence mortality is given by:

$$
\mu_{sen.i}(w) =  k_{sen} \left(\frac{log_{10}(w)}
                                     {log_{10}(w_{max.i})}\right)^{p_{sen}}
$$ {#eq-extmort} where $k_{sen}$ is the rate of senescence mortality, $p_{sen}$ 
defines the slope of the senescence curve, and $w_{max.i}$ is the maximum 
body size of functional group $i$ in grams.

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Reproduction]
:::

We use a senescence mortality rate of $k_{sen} =$ `r ext_mort$sen_prop` and
the exponent $p_{sen} =$ `r ext_mort$sen_curve`.

#### Fishing mortality

Like in `mizer`, fishing mortality in `mizerReef` is imposed on functional
groups by fishing gears. The total per-capita fishing mortality (1/year) is 
obtained by summing over the mortality from all gears,

$$
\mu_{f.i}(w) = \sum_g F_{g,i}(w),
$$

where the fishing mortality $F_{g,i}(w)$ imposed by gear $g$ on
functional group $i$ at size $w$ is calculated as:
$F_{g,i}(w) = S_{g,i}(w) Q_{g,i} E_{g}$,
where $S$ is the selectivity by group, gear and size, $Q$ is the 
catchability by group and gear and $E$ is the fishing effort by gear.

Fishing parameters for mizerReef models can be set up with `setFishing()`,
which contains the details of how to set up gears with different selectivities
and the capabilities of different functional groups.

Fishing mortality $\mu_{f.i}(w)$ is calculated with the function `getFMort()`.

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Plankton mortality]
:::

Many coral reef fisheries have limited regulation and takes are typically under-reported [@Newton_2007]. For this general example, we use a knife-edge selectivity function which defines a minimum fishing size above which
selectivity is 1 for all groups and sizes.

```{r}
#| label: tbl-fishing
#| tbl-cap: Selectivity parameters and catchability
params@gear_params %>%
    filter(catchability > 0) %>%
    select(species, knife_edge_size, catchability) %>%
    kable(row.names = FALSE,
          col.names = c("Functional Group", "Minimum fishing size [g]", 
                        "Catchability [1/year]"))
```

#### Plankton Mortality

The predation mortality rate on the plankton resource $P$ is given by 
a similar expression to the predation mortality on fish:
$$
  \mu_{P}(w_p) = \sum_j \mathtt{pred\_rate}_j(w_p)\, \theta_{jP}.
$$

### Reproduction {#reproduction}

#### Energy invested into reproduction

The total rate of investment into reproduction (grams/year) is found by
integrating the contribution from all individuals of species $i$, each
of which invests a proportion $\psi_i(w)$ of their consumption. This
total rate of energy investment can then be converted to a rate of
production of offspring $R_{p.i}$ (numbers per year): 
$$
  R_{p.i} = \frac{\epsilon_i}
                 {2 w_{min.i}}\int N_i(w)\,E_{r.i}(w)\,\psi_i(w)\,dw.
$$ {#eq-Rp} Here the total rate of investment is multiplied by an
efficiency factor $\epsilon$ and then divided by the offspring weight 
$w_{min}$ to convert the energy into number of offspring. The result is
multiplied by a factor $1/2$ to take into account that only females
contribute directly to offspring.

The size $w_{min}$ is the egg size.

#### Density-dependence in reproduction

Three important density-dependent mechanisms widely assumed in fisheries
models are automatically captured in the mizer model, which lead to an
emergent stock-recruitment relationship:

1.  High density of spawners leads to a reduced food income of the
    spawners and consequently reduced per-capita reproduction.
2.  High density of larvae leads to slower growth of larvae due to food
    competition, exposing the larvae to high mortality for a longer
    time, thereby decreasing the survivorship to recruitment size.
3.  High density of fish leads to more predation on eggs and fish larvae
    by other fish species or by cannibalism.

However there are other sources of density dependence that are not
explicitly modelled mechanistically in mizer. An example would be a
limited carrying capacity of suitable spawning grounds and other spatial
effects. This requires additional phenomenological density dependent
contributions to the stock-recruitment. In mizer this type of density
dependence is modelled through constraints on egg production and
survival. The default functional form of this density dependence is
represented by a reproduction rate $R_i$ (numbers per time) that
approaches a maximum as the energy invested in reproduction increases.
This is described by the common Beverton-Holt type function used in
fisheries science:

$$
  R_i = R_{\max.i} \frac{R_{p.i}}{R_{p.i} + R_{\max.i}},
$$ {#eq-R} where $R_{\max.i}$ is the maximum reproduction rate of
species $i$.

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Resources]
:::

The reproduction parameters $\epsilon_i$ and $R_{max.i}$ are not
directly observable. The values were instead chosen so as to produce
steady-state abundances of the species that are in line with
observations and to give reasonable values for the reproduction level.

@tbl-reproduction gives the steady-state reproduction level which is
defined as the ratio between the actual reproduction rate $R_i$ and the
maximal possible reproduction rate $R_{\max.i}$.

```{r}
#| label: tbl-reproduction
#| tbl-cap: Parameters determining reproduction
df <- params@species_params
#df$reproduction_level <- getReproductionLevel(params)
df %>%
    select(w_min, erepro, R_max) %>% # , reproduction_level) %>%
    kable()
```

## Resources {#resources}

The fish spectrum is fed by three background resources: the [plankton spectrum](#plankton), [algae](#algae), and [detritus](#detritus). Small
individuals of all species will feed on plankton while only herbivorous
groups and invertebrates feed on algae or detritus. The design of 
unstructured resources draws from the @mizerShelf model. 

### Plankton Spectrum {#plankton}

```{r}
wcutoff <- params@resource_params$w_pp_cutoff
lambda <- params@resource_params$lambda
kappa <- params@resource_params$kappa
```

The plankton spectrum $N_P(w)$ tracks the abundance all planktonic food
sources. This spectrum starts at a smaller size than the fish spectrum, 
in order to provide food for the smallest individuals (larvae) of the 
fish spectrum. The time evolution of the resource spectrum is described by 
a semi-chemostat equation as in mizer.

The semichemostat dynamics are given by:
$$
  \frac{\partial N_P(w,t)}{\partial t} 
  = r_P(w) \Big[ c_P (w) - N_P(w,t) \Big] - \mu_P(w) N_P(w,t).
$$
Here $r_p(w)$ is the plankton regeneration rate and $c_p(w)$ is the carrying
capacity in the absence of predation. By default, mizerReef assumes the same
allometric forms as mizer, $r_P(w)= r_P\, w^{n-1}.$ and 
$c_p(w)=\kappa\, w^{-\lambda}.$ 

The mortality $\mu_p(w)$ is due to predation by consumers and is described 
in the subsection [Resource mortality].

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Algae]
:::

The plankton spectrum ranges from 
$w_0=`r signif(min(params@w_full), digits = 1)`$ to $w_{cutoff}=`r wcutoff`$ 
grams. The steady state abundance of plankton at size 1g is $\kappa=`r kappa`[g/m^{-2}]$. The slope of the plankton spectrum $\lambda=`r lambda`$. 

### Algae

Algae, which consists of macroalgae and turfs, are an important resource
for herbivorous reef fish. The algae resource is described only by its total 
biomass $B_A$. Feeding on algae is not  is not size-based. Herbivores can
feed on algae of any size. 

The rate of change in the total algal biomass is simply the difference
between the rate at which algal biomass is produced and the rate at
which it is consumed, so $$
\frac{dB_A}{dt}=p_A - c_A\,B_A.
$$ {#eq-BC} We will discuss the production rate $p_A$ and the
consumption rate $c_AB_A$ below.

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Algae consumption]
:::

In the steady state the total algal biomass per square meter is
$B_A = `r signif(algae_biomass(params), digits = 4)`$ grams.

#### Algae consumption {#algae-consumption}

Algae is consumed by herbivorous fish. The rate at which algal biomass
is consumed is assumed to be proportional to the available algal
biomass. The proportionality factor $c_A$, which we refer to as the
"mass-specific consumption rate", depends on the abundance of consumers.

For each consumer species $i$, a parameter $\rho_{A.i}$ determines the
rate at which individuals of that species encounter algal biomass. The
rate is assumed to scale with the size of the herbivore raised to an
allometric exponent $n$ which is taken to be the same as the scaling
exponent of the maximum intake rate for consumers,

$$
E_{i.A}(w)=\rho_{i.A}\, w^n\,B_A
$$ {#eq-EC}

Finally we take into account the preference of herbivorous group $i$ for
algae, $\theta_{i.A}$. This gives the mass-specific algal consumption
rate:

$$
c_A = \sum_i\int\rho_{i.D}\, w^n N_i(w)\theta_{i.A}\,dw 
$$ {#eq-cC}

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Algae production]
:::

The parameters $\rho_{i.A}$ have units of $g^{-n}$ per year. They are
non-zero only for species that consume at least some algae. The
preference $\theta_{i.A}$ for algae is a value between 0 and 1
specifying the proportion of consumer diets that are comprised of 
algal matter.

```{r}
#| label: tbl-rho-a
#| tbl-cap: Parameters determining rates of algae consumption.
params@species_params %>%
    select(rho_algae) %>%
    rename(rho = rho_algae) %>%
    filter(rho > 0) %>%
    kable()
```

#### Algae production

```{r include=FALSE}
pA <- params@other_params$algae$algr
```

The rate $p_A$ at which algae biomass is produced by the ecosystem is
given by a constant growth rate with units of grams per unit area per
unit time.

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Detritus]
:::

The value of $p_A$ is `r params@other_params$algae$algae_growth` grams per 
square meter per year.

### Detritus

Detritus is consumed by herbivores and benthic invertebrates. Feeding on
detritus is not size-based as fish can feed on detritus particles of any
size. The detritus resource is described only by its total biomass
$B_D$.

The rate of change in the total detritus biomass is the difference between 
the rate at which detritus biomass is produced and the rate at which it is 
consumed, so

$$
\frac{dB_D}{dt}=p_D - c_D\,B_D.
$$ {#eq-dBd}

The production rate $p_D$ and the consumption rate $c_DB_D$ are discussed
below.

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Detritus consumption]
:::

In the steady state the total detritus biomass per square meter is
$B_A = `r signif(detritus_biomass(params), digits = 4)`$ grams.

#### Detritus consumption {#detritus-consumption}

The rate at which detritus biomass is consumed is assumed to be
proportional to the available detritus biomass. The proportionality
factor $c_D$, which we refer to as the "mass-specific consumption rate",
depends on the abundance of consumers.

For each consumer species $i$, a parameter $\rho_{D.i}$ determines the
rate at which individuals of that species encounter algal biomass. The
rate is assumed to scale with the size of the consumer raised to an
allometric exponent $n$ which is taken to be the same as the scaling
exponent of the maximum intake rate for consumers,

$$
E_{i.D}(w)=\rho_{i.D}\, w^n\,B_D
$$

Finally we take into account the preference of species group $i$ for
detritus, $\theta_{i.D}$. This gives the mass-specific detritus consumption
rate:

$$
c_D = \sum_i\int\rho_{i.D}\, w^n N_i(w)\theta_{i.D}\,dw 
$$

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [Detritus production]
:::

The parameters $\rho_{i.D}$ have units of $g^{-n}$ per year. They are
non-zero only for species that consume at least some detritus. The
preference $\theta_{i.D}$ for detritus is a value between 0 and 1
specifying the proportion of consumer diets comprised of detritus.

```{r}
#| label: tbl-rho-d
#| tbl-cap: Parameters determining rates of algae consumption.
params@species_params %>%
    select(rho_detritus) %>%
    rename(rho = rho_detritus) %>%
    filter(rho > 0) %>%
    kable()
```


#### Detritus production

The rate $p_D$ at which detritus biomass is produced by the ecosystem
has contributions from three sources, $$
p_D = p_{D.f} + p_{D.d} + p_{D.ext},
$$ {#eq-pD} each of which we will now discuss.

##### Feces

$p_{D.f}$ comes from the biomass that is consumed but not assimilated by
the predators, i.e., it comes from the feces expelled by the predators.
Let $\alpha_i$ be the proportion of the consumed biomass that is
assimilated by species $i$ and $E_i(w)$ the food encounter rate
discussed in the section on [consumption](#consumption). Then

$$
p_{D.f} = \sum_i(1-\alpha_i)\int E_i(w)\,dw.
$$ {#eq-pDf}

##### Decomposing Dead Organisms

$p_{D.d}$ comes from the biomass of fish that die as a result of sources
of external mortality such as transient predators, illness, and fishing.  
This external mortality include senescence and illness deaths that will
contribute to detritus, but also deaths due to fishing or predation by 
species that are not explicitly modelled, for example mammals or sea birds. 
Thus only a proportion of the external mortality decomposes to detritus. 
This proportion is given by a detritus parameter `prop_decomp` which
defaults to 80\% based on the finding that most organic material is recycled 
in the shallow water systems of coral reefs [@Hatcher_1988]. So 

$$
p_{D.d} = \sum_i\int\mu_{seni.i}(w)N_i(w)w\,dw + 
          \mathtt{prop\_decomp}\,\sum_i\int\mu_{nat.i}(w)N_i(w)w\,dw.
$$
###### Parameter values

::: {.content-visible when-format="html"}
Skip to [External]
:::

```{r}
#| include: false
p_d <- params@other_params$prop_decomp
```

The proportion of mass generated by natural mortality that is converted to
detritus is set to the default value of $\mathtt{prop\_decomp}=$ `r p_d`. 

##### External

$p_{D.ext}$ is the rate at which detritus enters the system from
external sources. This will mostly be detritus sinking in from the
pelagic zone. This rate is a model parameter independent of any other
model component.

##### Parameter values

::: {.content-visible when-format="html"}
Skip to [New metrics]
:::

```{r}
#| include: false
dext <- params@other_params$d.external
```

The value of the external detritus production rate is $p_{d.ext}=$ 
`r dext` grams per year. This was chosen so that the production and
consumption are equal for the chosen steady state abundances.

### New metrics

Since we may not want to implement fishing mortality directly in mizerReef 
models, it is valuable to include a tool for estimating how fisheries may
respond to changes in the ecosystem. The productivity of a system captures 
the flow and accumulation of biomass through processes like reproduction, 
growth, and predation, and does not require estimates of catch. As it cannot 
be observed directly, it is the perfect candidate for estimation with 
ecosystem models. 
 
Fisheries productivity refers to the rate at which fish biomass is produced 
and available for harvest in a given area over a given period of time. This 
value can be used to estimate the regeneration time of fish stocks and 
ultimately determine levels of sustainable harvest.
 
The productivity $P_i(w)$ of functional group $i$ is given by
$$
P_i(w) = \int_w^{w+dw} N_i(w) g_i(w) dw
$$
where $N_i(w)$ is the abundance density (number per square meter) of 
functional group $i$ and $g_i(w)$ is the energy rate available for growth 
after metabolism, movement and reproduction have been accounted for in grams 
per year. To account for gear and size restrictions on fish catches, 
productivity can be calculated for all fish within a designated size range. 
As many coral reef fisheries are minimally size and species selective, the 
default option is to calculate the productivity for all individuals over 
$7$ cm in length regardless of functional group.
 
#### Parameter values
  
```{r}
r_p <- params@other_params[['refuge_params']]
m_p <- params@other_params[['method_params']]
```
  
The steady state fisheries productivity for all functional groups is given
in @tbl-prod. This simulation reflects a reef with a `r print(r_p$method)` 
defined refuge profile with the maximum propoortion of refuge 
$r =}`r m_p$prop_protect` and body size at which refuge becomes scarce
$L_refuge =}`r m_p$L_refuge` cm.

```{r}
#| label: tbl-prod
#| tbl-cap: Potential fisheries productivity
df <- getProductivity(params)

df %>%
    kable(col.names = c("Productivity [g/m^2/yr]"))
```

# Vignettes

To demonstrate the use of mizerReef and how dynamics are impacted by
parameterisation, we have developed several vignettes that use the described 
steady state abundances and reproduction parameters.

## Changing the minimum size of refuge {#sec:ex1}

In this example we look at the consequences of changing $L_{refuge}$, the 
body length at which refuge availability rapidly decreases for prey.

### Changing the minimum fishing size 

Using the simulations from example [the previous section](#ex1), we explore
the sensitivity of fisheries productivity to the minimum fishing size 
parameter.

## Simulating fishing mortality

Here we examine how fishing mortality impacts our system. We use knife edge 
fishing gear. 

### Restricting fishing on herbivores

Now we can explore how these outcomes might change if fishers only harvested
from the predator guild. 

## Increasing the availability of the algal resource

There is often a boom in algal resources following mass coral mortality due to
bleaching or disturbance, and this can result in an explosion of herbivore
populations. Here we investigate model predictions when we increase the
availability of the algal resource.

# Conclusion

The mizerReef package presents a valuable and user-friendly tool with the 
predictive power to help elucidate outcomes for future reefs in the face
of global climate change.


