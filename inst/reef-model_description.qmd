---
title: "Model Description"
# bibliography: mizerReef-bib.bib
execute: 
  echo: false
format:
  html:
    toc: true
    toc-depth: 4
    code-fold: true
    code-link: true
  pdf:
    toc: true
    toc-depth: 4
    number-sections: true
    number-depth: 3
editor: 
  markdown: 
    wrap: 72
---

```{r}
#| include: false
library(ggplot2)
library(dplyr)
library(knitr)
library(mizer)
# remotes::install_github("sizespectrum/mizerExperimental")
library(mizerExperimental)
# remotes::install_github("cmbeese/mizerReef")
library(mizerReef)
params <- cbn_params
```

This document details the structure and parameters for a tropical coral
reef ecosystem model. The model consists of a collection of fish and
invertebrate [functional groups](#groups) supported by a collection of
[resource spectra](#resources). All predator-prey interactions are
mediated by habitat structure, which determines the availability of
[refuge](#refuge). Parameters were chosen to describe a Caribbean coral
reef ecosystem. Numerical values for the parameters associated with each
section are provided under the "Parameter values" subsections. Many of the 
parameters were taken from [@Beese2023] to allow for comparison
of results. 

::: {.content-visible when-format="html"}
These parameter value sections start with a "Skip" link that allows you
to jump over them to the next section of model description.
:::

# Functional Groups {#sec:groups}

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Size-spectrum dynamics]
:::

The model includes `r nrow(params@species_params)-1` functional groups
of fish as well as a general group of benthic invertebrates. Estimates
of observed abundances for each group are not direct model parameters
but rather were used to select reproduction parameters (discussed later)
so that the steady state abundances in the model agree with these
observations.

Biomass estimates for most functional groups were based on data
collected in Bonaire [@rogers2014]. The survey methods used were unable
to detect cryptic or nocturnal species or individuals smaller than 10 cm
in length. Biomass estimates for carnivorous eels, noctural
invertivores, and cryptobenthic predators were taken from the literature
[@REFERENCE]. The minimum size observed, or cutoff size, for each
species is given in @tbl-biomass along with the observed biomass per
square meter in grams.

```{r}
#| label: tbl-biomass
#| tbl-cap: Observed biomasses
params@species_params %>%
    filter(!is.na(biomass_observed)) %>%
    select(biomass_observed, biomass_cutoff) %>%
    kable(col.names = c("Biomass [g/m^2]", "cutoff size [g]"))
```

## Size-spectrum dynamics

The model assumes that, to a first approximation, an individual can be
characterized by its weight $w$ and its functional group number $i$
only. The aim of the model is to calculate the size spectrum $N_i(w)$,
which is the *density* of individuals of functional group $i$ and size
$w$. The number of individuals in a size range is obtained from the
density by integrating over the size range, such that
$\int_w^{w+dw}N_i(w)dw$ is the number of individuals of group $i$ in the
size interval $[w,w+dw]$. In other words: the number of individuals in a
size range is the area under the number density $N_i(w)$.

The time evolution of the number density $N_i(w)$ is described by the
McKendrick-von Foerster equation, which is a transport equation
describing the transport of biomass from small to large individuals,
with an additional loss term due to fish mortality:

$$
  \frac{\partial N_i(w)}{\partial t} + \frac{\partial g_i(w) N_i(w)}{\partial w} 
  = -\mu_i(w) N_i(w).
$$ {#eq-MvF}

The individual growth rate $g_i(w)$ is described below in the
[Growth](#growth) section and the mortality rate $\mu_i(w)$ is described
in the [Mortality](#mortality) section. These rates depend on the
structural complexity of the reef and the density of other fish of other
sizes, as well as biomass of plankton, algae and detritus resources,
making the size-spectrum dynamics non-linear and non-local in very
interesting ways. The resulting effects are too complicated to
disentangle by pure thought. This is where simulations with the mizer
package come in.

There is no need to understand the mathematical notation used in the
McKendrick-von Foerster equation to understand its origin: it just says
that the rate at which the number of fish in a size bracket increases is
the rate at which fish grow into the size bracket from a smaller size
minus the rate at which fish grow out of it to a larger size minus the
rate at which the fish in the size bracket die.

For the smallest size class, instead of a rate of growth into the size
class there is a rate of reproduction of new individuals into that size
class. This reproduction will be described below in the
[Reproduction](#reproduction) section.

## Growth {#growth}

Consumers can only grow by consuming food (i.e. plankton, algae,
detritus, or other fish), discounting the losses due to metabolic
processes. Predation includes a model for the [predator-prey encounter
rate](#sec:pref) and a model for the rate of [consumption](#consumption). 
The rate at which predators encounter prey is modified by habitat 
complexity, which provides predation refuge that prevents certain prey 
from being encountered. Taking into account the rate of 
[metabolic losses], the resulting energy intake can be partitioned 
in the model as energy allocated to [reproduction](#sec:repro) and 
energy allocated to [somatic growth](#somatic-growth).

### Predator-prey encounter rate {#sec:pref}

The rate $E_{i}(w)$ at which a predator of group $i$ and weight $w$
encounters food (mass per time) is obtained by summing over all prey
group and integrating over all prey sizes $w_p$, weighted by the
selectivity factors described below and (where relevant) adding the
encounter rates $E_{A.i}$ of algae and $E_{D.i}$ of detritus:

$$
  E_{i}(w) = \gamma_i(w) \int \sum_{j} \theta_{ij} V_{ij}(w_p) N_j(w_p)
  \phi_i(w,w_p) w_p \, dw_p + E_{A.i}(w) + E_{D.i}(w).
$$ {#eq-encounter}

The encounter rates for [algae](#algae-consumption) and
[detritus](#detritus-consumption) are described in later sections.

The overall prefactor $\gamma_i(w)$ sets the predation power of the
predator. It could be interpreted as a search volume or as an attack
rate. By default it is assumed to scale allometrically as
$\gamma_i(w) = \gamma_i\, w^{3/4}.$ In order for $E_i(w)$ to have units
of grams per year, the prefactor $\gamma_i$ has to have a unit of
$\text{grams}^{-3/4}$ per year.

The $\theta_{ij}$ matrix sets the interaction strength between predator
group $i$ prey group $j$.

$V_{ij}(w_p)$ sets the vulnerability of prey species $j$ and weight
$w_p$ to predation by predator species $i$. Vulnerability is determined
by the presence of [predation refuge](#refuge).

The size selectivity is encoded in the predation kernel $\phi_i(w,w_p)$.
For most groups we use the lognormal predation kernel given as

$$
\phi_i(w, w_p) = 
\exp \left[ \frac{-(\ln(w / w_p / \beta_i))^2}{2\sigma_i^2} \right]
$$ {#eq-phi_normal} if $w/w_p$ is larger than 1 and zero otherwise. Here
$\beta_i$ is the preferred predator-prey mass ratio and $\sigma_i$
determines the width of the kernel.

<!-- For grabbing piscivores and cryptobenthics, which tend to be eat larger -->
<!-- prey, we use a power-law kernel with sigmoidal cutoffs given by -->

<!-- $$ -->
<!-- \phi_i(w, w_p) =  -->
<!-- \frac{(w/w_p)^s}{\left(1+e^{l_l}\frac{w_p}{w}\right)^{u_l} -->
<!-- \left(1+e^{-l_r}\frac{w}{w_p}\right)^{u_r}}. -->
<!-- $$ {#eq-phi_power} Here the parameters $l_l$ and $u_l$ determine the -->
<!-- sigmoidal cutoff at low predator/prey mass ratio and $l_r$ and $u_r$ -->
<!-- similarly determine the cutoff at large predator/prey mass ratio. -->

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Predation Refuge](#refuge)
:::

The predator/prey interaction matrix has entries equal to either 0 (if
the groups can not interact) or 1, see @fig-interaction.

```{r}
#| label: fig-interaction
#| fig-cap: "group interaction matrix"
ggplot(melt(params@interaction),
       aes(x = prey, y = reorder(predator, desc(predator)), fill = value)) + 
    geom_tile(colour = "black", linewidth = 0.25) +
    scale_fill_gradient(low = "white", high = "blue", limit = c(0, 1),
                        guide = "legend") +
    ylab("predator") +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

The parameters for the predation kernels were estimated based on values
found in the literature [@REFERENCE]. For the species that use a
lognormal predation kernel, the parameters are given in @tbl-lognormal.

```{r results='asis'}
#| label: tbl-lognormal
#| tbl-cap: Parameters for the lognormal predation kernels
params@species_params %>%
    filter(pred_kernel_type == "lognormal") %>%
    select(beta, sigma, gamma) %>%
    kable()
```

<!-- For the species that use a truncated power law predation kernel, the -->
<!-- parameters are given in @tbl-power. -->

<!-- ```{r results='asis'} -->
<!-- #| label: tbl-power -->
<!-- #| tbl-cap: Parameters for the power-law predation kernels -->
<!-- params@species_params %>% -->
<!--     filter(pred_kernel_type == "power_law") %>% -->
<!--     select(starts_with("kernel"), gamma) %>% -->
<!--     rename(s = kernel_exp, -->
<!--            l_l = kernel_l_l, -->
<!--            u_l = kernel_u_l, -->
<!--            l_r = kernel_l_r, -->
<!--            u_r = kernel_u_r) %>% -->
<!--     kable() -->
<!-- ``` -->

### Predation Refuge {#refuge}

Complex biogenic structures mediate the process of predation on reef
habitats. To account for this, we reduce the rate at which a predator
encounters prey at a level proportional to the availability of
appropriately sized **predation refuges**, which prevent prey fish from
being encountered. The refuge function, $R_j(w_p)$, describes the
proportion of fish of size $w_p$ in prey group $j$ that are hidden from
predators. We refer to the set of proportions that describe refuge
availability across the entire size range of model fish as a 
**refuge profile**. $1 - R_j(w_p)$ is then the proportion of fish,
of weight $w_p$ min group $j$ that are vulnerable to consumption 
by predators.

Individuals smaller than $w_{min}$ represent pelagic larval fish that 
have not yet settled to the reef substrate. The default value for this 
minimum weight is 0.1 grams. All individuals below this size are assumed 
to be vulnerable to predation. Additionally, refuge can be suppressed for 
functional groups which are not expected to utilize biogenic structures 
for protection (e.g. schooling species) with the [refuge\_user] parameter 
in the species parameters data frame.

The mizerReef package provides three methods to define the overall
refuge profile of a reef depending on the availability of complexity
data for the modelled area.

##### Simple Method

This method is best suited to data-poor reefs or reefs where the refuge
distribution is unknown. The proportion of prey of weight $w_p$ and
functional group $j$ with access to refuge $R_j(w_p)$ is given by:

$$
R_j(w_p) = \frac{-r}{1 + e^{\left(-\alpha (w - W_{max})\right)}} + r
$$ {#eq-refuge_simple}

where $W_{max}$ defines the prey body size at which no crevices in the
reef are large enough to act as a refuge. Refuge is available to a
constant proportion $r$ of fish smaller than $W_{max}$. The slope
$\alpha$ describes the sharpness of the cutoff for fish larger than
$W_{max}$. A shallower slope indicates a more gradual decline in refuge
availability with increasing body size. The default value for $\alpha$
sets a steep slope of $100$.

##### Binned Method

This method is appropriate for theoretical applications and does not
rely on complexity data. It sets the availability of refuge to a
constant proportion of fish within a given size range. The proportion of
fish in functional group $j$ and weight $w_p$ with access to refuge
$R_j(w_p)$ is given by:

$$
R_j(w_p) = r_k ~~~~~~~ w_p \in (~w_{k-1}, w_k~]
$$ {#eq-refuge_binned}

where $w_p$ is the weight of the prey and $r_k$ is the proportion of
fish with access to refuge in size class $k$.

##### Data Method

This method is appropriate when **refuge density** data is available for
the modeled reef. The **refuge density** describes the distribution of
refuges across defined fish body size categories. The proportion of prey
of weight $w_p$ and functional group $j$ with access to refuge
$R_j(w_p)$ is given by:

$$
R_j(w_p) = \tau\cdot\frac{\eta_k}{\sum_{i}\int_{w_{k-1}}^{w_k} N_i(w)~dw}
            ~~~~~~~ w_p \in (~w_{k-1}, w_k~]
$$ {#eq-refuge_data}

where $\tau$ is the proportion of fish with access to refuge that are
expected to utilize it, $\eta_k$ is the density of refuges in size range
$(w_{k-1}, w_k]$ and $\sum_{i} \int_{w_{k-1}}^{w_k} N_i(w)~dw$ gives the
total number of fish from any group in size range $(w_{k-1}, w_k]$.
This represents the density of competitors for refuges in size class
$k$.

##### Vulnerability

The vulnerability of prey of weight $w_p$ in group $j$ to predation by a
predator in functional group $i$ is then given by:

$$
V_{ij}(w_p) =  1 - \nu_i\cdot R_j(w_p)
$$ {#eq-vulnerability}

where $\nu_i$ represents whether predators in functional group $i$ are
able to access prey within refuge. For functional groups where $\nu_i$
is false, some aspect of their morphology or foraging strategy allows
them to access prey hidden in refuge; for example large eels that can
fit into crevices much smaller than their body size. For these
predators, vulnerability for all prey is set to 1.

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Consumption](#consumption)
:::

The refuge profile gives the proportion of fish at each size that are
protected from being encounter by predators, see @fig-refuge.

```{r}
#| label: fig-refuge
#| fig-cap: "Example refuge profile"
plotRefuge(params)
```

@tbl-refuge indicates which prey functional groups use refuge to escape
from predators and which predator groups are able to access prey within
refuge.

```{r}
#| label: tbl-refuge
#| tbl-cap: "refuge behaviour"
params@species_params %>%
    select(refuge_user, bad_pred) %>%
    mutate(refuge_user  = case_when(refuge_user == TRUE ~ 'Yes',
                                    refuge_user == FALSE ~ 'No')) %>%
    mutate(bad_pred = case_when(bad_pred == TRUE ~ 'No',
                                bad_pred == FALSE ~ 'Yes')) %>%
    kable(col.names = c("Uses refuge?", "Accesses prey in refuge?"))
```

### Consumption {#consumption}

For all non-piscivorous functional groups, encountered food is consumed
subject to a standard Holling functional response type II to represent
satiation. This determines the *feeding level* $f_i(w)$, which is a
dimensionless number between 0 (no food) and 1 (fully satiated) so that
$1-f_i(w)$ is the proportion of the encountered food that is consumed.
The feeding level is given by

$$
  f_i(w) = \frac{E_i(w)}{E_i(w) + h_i(w)},
$$ {#eq-fl} where $h_i(w)$ is the maximum consumption rate of a consumer
of group $i$ and weight $w$. By default we assume an allometric form
$h_i(w) = h_i\, w^n$ with $n=0.7$. The unit of the coefficients $h_i$
are $\text{grams}^{1-n}$ per year.

The rate at which food is consumed by an individual of group $i$ and
weight $w$ is then $$
(1-f_i(w))E_{i}(w)=f_i(w)\, h_i(w).
$$ {#eq-consumption} Only a proportion $\alpha_i$ of this consumed
biomass is retained, while a proportion $1-\alpha_i$ is expelled in the
form of feces, which contribute to detritus.

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Metabolic losses]
:::

Feeding level is only applied for non-piscivorous consumers and no maximum
consumption rate is imposed for piscivorous functional groups.

For consumers of algae and detritus, the values for the coefficients 
$h_i$ in the maximum consumption rates were chosen so that the feeding 
level that fish experience has a reasonable value with fish being 
neither too starved nor totally satiated.

```{r}
#| label: tbl-h
#| tbl-cap: Consumption parameters
params@species_params %>%
    filter(pisc == FALSE) %>%
    select(h, alpha) %>%
    kable()
```

```{r}
# plotFeedingLevel(params)
```

### Metabolic losses

Some of the food consumed is used to fuel the needs for metabolism,
activity and movement, at a rate $\mathtt{metab}_i(w)$. By default this
is made up out of standard metabolism, scaling with exponent $p$, and
loss due to activity and movement, scaling with exponent $1$: $$
\mathtt{metab}_i(w) = k_{s.i}\,w^p + k_i\,w.
$$ {#eq-metab} The units of the coefficients $k_{s.i}$ are
$\text{grams}^{1-p}$ per year and the units of the $k_i$ is grams per
year.

The remaining energy, if any, is then available for growth and
reproduction, at the rate $$
  E_{r.i}(w) = \max(0, \alpha_i f_i(w)\, h_i(w) - \mathtt{metab}_i(w))
$$ {#eq-Er}

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Investment into reproduction](#sec:repro)
:::

```{r}
#| label: tbl-metab
#| tbl-cap: Metabolism parameters
params@species_params %>%
    select(ks, p, k) %>%
    kable()
```

### Investment into reproduction {#sec:repro}

A proportion $\psi_i(w)$ of the energy available for growth and
reproduction is used for reproduction. This proportion changes from zero
below the weight $w_{mat.i}$ of maturation to one at the maximum weight
$w_{max.i}$, where all available energy is used for reproduction. The
expression is $$ 
\psi_i(w) = \begin{cases}
\left[1+\left(\frac{w}{w_{mat}}\right)^{-U}\right]^{-1}
\left(\frac{w}{w_{max}}\right)^{m-n}&w<w_{max}\\
1&w\geq w_{max}\end{cases}
$$ {#eq-psi} with $m-n = 0.3$ and $U=10$ (which sets the steepness of
the sigmoidal switch-on of reproduction at around the maturity weight
$w_{mat}$).

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Somatic growth](#somatic-growth)
:::

```{r}
#| label: tbl-repro
#| tbl-cap: Parameters determining the investment into reproduction.
params@species_params %>%
    select(w_mat, w_max) %>%
    kable()
```

### Somatic growth {#somatic-growth}

What is left over after metabolism and reproduction is taken into
account is invested in somatic growth. Thus the growth rate of an
individual of functional group $i$ and weight $w$ is $$
  g_i(w) = E_{r.i}(w)\left(1-\psi_i(w)\right).
$$ {#eq-growth} When food supply does not cover the requirements of
metabolism and activity, growth and reproduction stops, i.e. there is no
negative growth.

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Mortality](#mortality)
:::

The values for the model parameters were chosen so that the resulting
growth curves would be close to von Bertalanffy growth curves. The
parameters in @tbl-kvb were taken from the literature.

```{r}
#| label: tbl-kvb
#| tbl-cap: Parameters for observed vonBertalanffy growth curves and length-weight relationships
params@species_params %>%
    select(k_vb, a, b) %>%
    kable()
```

Here the parameters $a$ and $b$ are parameters for the allometric
weight-length relationship $w = a l^b$ where $w$ is measured in grams
and $l$ is measured in centimetres.

```{r, out.width="100%"}
#| label: fig-growth
#| fig-cap: Comparison of model growth curves with von Bertalanffy growth curves.
# plotGrowthCurves(params, species_panel = TRUE)
```

## Mortality {#mortality}

The mortality rate $\mu_i(w)$ of an individual of group $i$ and weight
$w$ has two sources: predation mortality $\mu_{p.i}(w)$ and external mortality
$\mu_{ext.i}(w)$. External mortality is composed of residual natural 
mortality $\mu_{nat.i}(w)$, and senescence $\mu_{sen.i}(w)$. The mortality
rate for group $i$ is then given by: 
$$
\mu_i(w)=\mu_{p.i}(w)+\mu_{ext.i}(w)
$$ {#eq-mort} We will now explain each of the terms.

### Predation mortality

All consumption by fish translates into corresponding predation
mortalities on the ingested prey individuals. Recalling that
$V_{ij}(w_p)$ is the proportion of prey species $i$ and weight $w_p$
encountered by a predator of group $j$, the rate at which all predators
from $j$ consume prey of size $w_p$ is $$
  \mathtt{pred\_rate}_j(w_p) = \int \phi_j(w,w_p) 
                              \sum_i V_{ij}(w_p)\,  \gamma_j(w) N_j(w) \, dw.
$$ {#eq-pred_rate}

The mortality rate due to predation is then obtained as $$
  \mu_{p.i}(w_p) = \sum_j \mathtt{pred\_rate}_j(w_p)\, \theta_{ji}.
$$ {#eq-mup}

### Residual natural mortality {#extmort}

Mortality caused by illness, fishing, or predators not explicitly included 
in the model is captured by $\mu_{nat}(w)$, which is independent of the
functional groups and group abundances. It is assumed to decrease 
allometrically with body size:

$$
\mu_{ext.i}(w) = \mu_{nat} w^{1 - n}
$$ {#eq-z0} where $\mu_{nat}$ is the residual natural mortality rate 
and $n$ is the allometric scaling exponent. 

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Senescence mortality]
:::

```{r, include = FALSE}
ext_mort <- params@other_params[['ext_mort_params']]
```

We use a residual mortality rate of $\mu_{nat} =$ `r ext_mort$nat_mort`

### Senescence mortality {#senmort}

Senescence mortality $\mu_{sen.i}(w)$ is intended to capture mortality due 
to illness or old age. It is independent of group abundances. Senescence 
mortality is assumed to increase allometrically with body size. The rate 
of senescence mortality is given by:

$$
\mu_{sen.i}(w) =  k_{sen} \left(\frac{log_{10}(w)}
                                     {log_{10}(w_{max.i})}\right)^{p_{sen}}
$$ {#eq-extmort} where $k_{sen}$ is the rate of senescence mortality, $p_{sen}$ 
defines the slope of the senescence curve, and $w_{max.i}$ is the maximum 
body size of functional group $i$ in grams.

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Reproduction]
:::

We use a senescence mortality rate of $k_{sen} =$ `r ext_mort$sen_prop` and
the exponent $p_{sen} =$ `r ext_mort$sen_curve`.

## Reproduction {#reproduction}

### Energy invested into reproduction

The total rate of investment into reproduction (grams/year) is found by
integrating the contribution from all individuals of species $i$, each
of which invests a proportion $\psi_i(w)$ of their consumption. This
total rate of energy investment can then be converted to a rate of
production of offspring $R_{p.i}$ (numbers per year): 
$$
  R_{p.i} = \frac{c_{reef}\epsilon_i}
                 {2 w_{min.i}}\int N_i(w)\,E_{r.i}(w)\,\psi_i(w)\,dw.
$$ {#eq-Rp} Here the total rate of investment is multiplied by an
efficiency factor $\epsilon$ and connectivity constant $c_{reef}$ to account
for the connectivity of the modelled reef and then dividing by the offspring 
weight $w_{min}$ to convert the energy into number of offspring. The result is
multiplied by a factor $1/2$ to take into account that only females
contribute directly to offspring.

The size $w_{min}$ is the size at which the offspring settle on the reef.

### Density-dependence in reproduction

Three important density-dependent mechanisms widely assumed in fisheries
models are automatically captured in the mizer model, which lead to an
emergent stock-recruitment relationship:

1.  High density of spawners leads to a reduced food income of the
    spawners and consequently reduced per-capita reproduction.
2.  High density of larvae leads to slower growth of larvae due to food
    competition, exposing the larvae to high mortality for a longer
    time, thereby decreasing the survivorship to recruitment size.
3.  High density of fish leads to more predation on eggs and fish larvae
    by other fish species or by cannibalism.

However there are other sources of density dependence that are not
explicitly modelled mechanistically in mizer. An example would be a
limited carrying capacity of suitable spawning grounds and other spatial
effects. This requires additional phenomenological density dependent
contributions to the stock-recruitment. In mizer this type of density
dependence is modelled through constraints on egg production and
survival. The default functional form of this density dependence is
represented by a reproduction rate $R_i$ (numbers per time) that
approaches a maximum as the energy invested in reproduction increases.
This is described by the common Beverton-Holt type function used in
fisheries science:

$$
  R_i = R_{\max.i} \frac{R_{p.i}}{R_{p.i} + R_{\max.i}},
$$ {#eq-R} where $R_{\max.i}$ is the maximum reproduction rate of
species $i$.

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Carrion]
:::

The reproduction parameters $\epsilon_i$ and $R_{max.i}$ are not
directly observable. The values were instead chosen so as to produce
steady-state abundances of the species that are in line with
observations and to give reasonable values for the reproduction level.

@tbl-reproduction gives the steady-state reproduction level which is
defined as the ratio between the actual reproduction rate $R_i$ and the
maximal possible reproduction rate $R_{\max.i}$.

```{r}
#| label: tbl-reproduction
#| tbl-cap: Parameters determining reproduction
df <- params@species_params
#df$reproduction_level <- getReproductionLevel(params)
df %>%
    select(w_min, erepro, R_max) %>% # , reproduction_level) %>%
    kable()
```

# Resource Spectra {#resources}

## Algae

Algae, which consists of macroalgae and turfs, are an important resource
for herbivorous reef fish. The algae resource is described only by its total 
biomass $B_A$. Feeding on algae is not  is not size-based. Herbivores can
feed on algae of any size. 

The rate of change in the total algal biomass is simply the difference
between the rate at which algal biomass is produced and the rate at
which it is consumed, so $$
\frac{dB_A}{dt}=p_A - c_A\,B_A.
$$ {#eq-BC} We will discuss the production rate $p_A$ and the
consumption rate $c_AB_A$ below.

### Parameter values

In the steady state the total algal biomass per square meter is
$B_A = `r signif(algae_biomass(params), digits = 4)`$ grams.

### Algae consumption {#algae-consumption}

Algae is consumed by herbivorous fish. The rate at which algal biomass
is consumed is assumed to be proportional to the available algal
biomass. The proportionality factor $c_A$, which we refer to as the
"mass-specific consumption rate", depends on the abundance of consumers.

For each consumer species $i$, a parameter $\rho_{A.i}$ determines the
rate at which individuals of that species encounter algal biomass. The
rate is assumed to scale with the size of the herbivore raised to an
allometric exponent $n$ which is taken to be the same as the scaling
exponent of the maximum intake rate for consumers,

$$
E_{i.A}(w)=\rho_{i.A}\, w^n\,B_A
$$ {#eq-EC}

Finally we take into account the preference of herbivorous group $i$ for
algae, $\theta_{i.A}$. This gives the mass-specific algal consumption
rate:

$$
c_A = \sum_i\int\rho_{i.D}\, w^n N_i(w)\theta_{i.A}\,dw 
$$ {#eq-cC}

#### Parameter values

::: {.content-visible when-format="html"}
Skip to [Algae production]
:::

The parameters $\rho_{i.A}$ have units of $g^{-n}$ per year. They are
non-zero only for species that consume at least some algae. The
preference $\theta_{i.A}$ for algae is a value between 0 and 1
specifying the proportion of consumer diets that are comprised of 
algal matter.

```{r}
#| label: tbl-rho-a
#| tbl-cap: Parameters determining rates of algae consumption.
params@species_params %>%
    select(rho_algae) %>%
    rename(rho = rho_algae) %>%
    filter(rho > 0) %>%
    kable()
```

### Algae production

```{r include=FALSE}
pA <- params@other_params$algae$algr
```

The rate $p_A$ at which algae biomass is produced by the ecosystem is
given by a constant growth rate with units of grams per unit area per
unit time.

#### Parameter values

The value of $p_A$ is `r params@other_params$algae$algae_growth` grams per 
square meter per year.

## Detritus

Detritus is consumed by herbivores and benthic invertebrates. Feeding on
detritus is not size-based as fish can feed on detritus particles of any
size. The detritus resource is described only by its total biomass
$B_D$.

The rate of change in the total detritus biomass is the difference between 
the rate at which detritus biomass is produced and the rate at which it is 
consumed, so

$$
\frac{dB_D}{dt}=p_D - c_D\,B_D.
$$ {#eq-dBd}

The production rate $p_D$ and the consumption rate $c_DB_D$ are discussed
below.

### Parameter values

In the steady state the total detritus biomass per square meter is
$B_A = `r signif(detritus_biomass(params), digits = 4)`$ grams.

### Detritus consumption {#detritus-consumption}

The rate at which detritus biomass is consumed is assumed to be
proportional to the available detritus biomass. The proportionality
factor $c_D$, which we refer to as the "mass-specific consumption rate",
depends on the abundance of consumers.

For each consumer species $i$, a parameter $\rho_{D.i}$ determines the
rate at which individuals of that species encounter algal biomass. The
rate is assumed to scale with the size of the consumer raised to an
allometric exponent $n$ which is taken to be the same as the scaling
exponent of the maximum intake rate for consumers,

$$
E_{i.D}(w)=\rho_{i.D}\, w^n\,B_D
$$

Finally we take into account the preference of species group $i$ for
detritus, $\theta_{i.D}$. This gives the mass-specific detritus consumption
rate:

$$
c_D = \sum_i\int\rho_{i.D}\, w^n N_i(w)\theta_{i.D}\,dw 
$$

#### Parameter values

The parameters $\rho_{i.D}$ have units of $g^{-n}$ per year. They are
non-zero only for species that consume at least some detritus. The
preference $\theta_{i.D}$ for detritus is a value between 0 and 1
specifying the proportion of consumer diets comprised of detritus.

```{r}
#| label: tbl-rho-d
#| tbl-cap: Parameters determining rates of algae consumption.
params@species_params %>%
    select(rho_detritus) %>%
    rename(rho = rho_detritus) %>%
    filter(rho > 0) %>%
    kable()
```


### Detritus production

The rate $p_D$ at which detritus biomass is produced by the ecosystem
has contributions from three sources, $$
p_D = p_{D.f} + p_{D.d} + p_{D.ext},
$$ {#eq-pD} each of which we will now discuss.

#### Feces

$p_{D.f}$ comes from the biomass that is consumed but not assimilated by
the predators, i.e., it comes from the feces expelled by the predators.
Let $\alpha_i$ be the proportion of the consumed biomass that is
assimilated by species $i$ and $E_i(w)$ the food encounter rate
discussed in the section on [consumption](#consumption). Then

$$
p_{D.f} = \sum_i(1-\alpha_i)\int E_i(w)\,dw.
$$ {#eq-pDf}

#### Decomposing Dead Organisms

$p_{D.d}$ comes from the biomass of fish that die as a result of sources
of external mortality such as transient predators, illness, and fishing.  
This external mortality include senescence and illness deaths that will
contribute to detritus, but also deaths due to fishing or predation by 
species that are not explicitly modelled, for example mammals or sea birds. 
Thus only a proportion of the external mortality decomposes to detritus. 
This proportion is given by a detritus parameter `prop_decomp`. So 

$$
p_{D.d} = \sum_i\int\mu_{seni.i}(w)N_i(w)w\,dw + 
          \mathtt{prop\_decomp}\,\sum_i\int\mu_{nat.i}(w)N_i(w)w\,dw.
$$

#### External

$p_{D.ext}$ is the rate at which detritus enters the system from
external sources. This will mostly be detritus sinking in from the
pelagic zone. This rate is a model parameter independent of any other
model component.

##### Parameter values

```{r}
#| include: false
dext <- params@other_params$d.external
```

The value of the external detritus production rate is $p_{d.ext}=$ 
`r dext` grams per year. This was chosen so that the production and
consumption are equal for the chosen steady state abundances.
